<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NACHA Vendor Payments - Nonprofit Fund Accounting</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .section-header {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 5px solid #0d6efd;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status-draft {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-approved {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .status-processed {
            background-color: #cfe2ff;
            color: #084298;
        }
        .status-error {
            background-color: #f8d7da;
            color: #842029;
        }
        .bank-account-card {
            border-left: 4px solid #0d6efd;
        }
        .bank-account-card.primary {
            border-left: 4px solid #198754;
        }
        .payment-item {
            transition: all 0.2s;
        }
        .payment-item:hover {
            background-color: #f8f9fa;
        }
        .badge-account {
            font-size: 0.8rem;
            font-family: monospace;
        }
        .tab-pane {
            padding: 20px 0;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        .account-number-masked {
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Nonprofit Fund Accounting</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="vendor-payments.html">Vendor Payments</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1>NACHA Vendor Payments</h1>
                <p class="lead">Manage vendors, payment batches, and generate NACHA files for ACH transfers.</p>
            </div>
        </div>

        <ul class="nav nav-tabs" id="paymentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="batches-tab" data-bs-toggle="tab" data-bs-target="#batches" type="button" role="tab">Payment Batches</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="vendors-tab" data-bs-toggle="tab" data-bs-target="#vendors" type="button" role="tab">Vendors</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">NACHA Settings</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">NACHA Files</button>
            </li>
        </ul>

        <div class="tab-content" id="paymentTabsContent">
            <!-- PAYMENT BATCHES TAB -->
            <div class="tab-pane fade show active" id="batches" role="tabpanel">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h2>Payment Batches</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createBatchModal">
                        <i class="fas fa-plus"></i> New Batch
                    </button>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="batchSearchInput" placeholder="Search batches...">
                            <button class="btn btn-outline-secondary" type="button" id="batchSearchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end">
                            <select class="form-select me-2" id="batchStatusFilter" style="width: auto;">
                                <option value="">All Statuses</option>
                                <option value="draft">Draft</option>
                                <option value="pending_approval">Pending Approval</option>
                                <option value="approved">Approved</option>
                                <option value="processed">Processed</option>
                            </select>
                            <button class="btn btn-outline-secondary" id="refreshBatchesBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="batchesTable">
                        <thead>
                            <tr>
                                <th>Batch Number</th>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Entity</th>
                                <th>Total Amount</th>
                                <th>Items</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="batchesTableBody">
                            <!-- Batch rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Batch Details Section (hidden initially) -->
                <div id="batchDetailsSection" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 id="batchDetailsTitle">Batch Details</h3>
                            <div>
                                <button id="approveBatchBtn" class="btn btn-success me-2" style="display: none;">
                                    <i class="fas fa-check"></i> Approve Batch
                                </button>
                                <button id="generateNachaBtn" class="btn btn-primary me-2" style="display: none;">
                                    <i class="fas fa-file-export"></i> Generate NACHA File
                                </button>
                                <button id="addPaymentItemBtn" class="btn btn-outline-primary me-2" style="display: none;">
                                    <i class="fas fa-plus"></i> Add Payment
                                </button>
                                <button id="closeBatchDetailsBtn" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">Batch Number:</dt>
                                        <dd class="col-sm-8" id="detailBatchNumber"></dd>
                                        
                                        <dt class="col-sm-4">Description:</dt>
                                        <dd class="col-sm-8" id="detailDescription"></dd>
                                        
                                        <dt class="col-sm-4">Entity:</dt>
                                        <dd class="col-sm-8" id="detailEntity"></dd>
                                        
                                        <dt class="col-sm-4">Fund:</dt>
                                        <dd class="col-sm-8" id="detailFund"></dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">Batch Date:</dt>
                                        <dd class="col-sm-8" id="detailBatchDate"></dd>
                                        
                                        <dt class="col-sm-4">Effective Date:</dt>
                                        <dd class="col-sm-8" id="detailEffectiveDate"></dd>
                                        
                                        <dt class="col-sm-4">Status:</dt>
                                        <dd class="col-sm-8" id="detailStatus"></dd>
                                        
                                        <dt class="col-sm-4">NACHA Company:</dt>
                                        <dd class="col-sm-8" id="detailNachaCompany"></dd>
                                    </dl>
                                </div>
                            </div>
                            
                            <h4 class="mt-4">Payment Items</h4>
                            <div class="table-responsive">
                                <table class="table table-striped" id="paymentItemsTable">
                                    <thead>
                                        <tr>
                                            <th>Vendor</th>
                                            <th>Bank Account</th>
                                            <th>Amount</th>
                                            <th>Memo</th>
                                            <th>Invoice #</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentItemsTableBody">
                                        <!-- Payment items will be inserted here -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th colspan="2" class="text-end">Total:</th>
                                            <th id="paymentItemsTotal">$0.00</th>
                                            <th colspan="4"></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VENDORS TAB -->
            <div class="tab-pane fade" id="vendors" role="tabpanel">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h2>Vendors</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createVendorModal">
                        <i class="fas fa-plus"></i> New Vendor
                    </button>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="vendorSearchInput" placeholder="Search vendors...">
                            <button class="btn btn-outline-secondary" type="button" id="vendorSearchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end">
                            <select class="form-select me-2" id="vendorStatusFilter" style="width: auto;">
                                <option value="">All Statuses</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                            <button class="btn btn-outline-secondary" id="refreshVendorsBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="vendorsTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Bank Accounts</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vendorsTableBody">
                            <!-- Vendor rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Vendor Details Section (hidden initially) -->
                <div id="vendorDetailsSection" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 id="vendorDetailsTitle">Vendor Details</h3>
                            <div>
                                <button id="editVendorBtn" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-edit"></i> Edit Vendor
                                </button>
                                <button id="addBankAccountBtn" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-plus"></i> Add Bank Account
                                </button>
                                <button id="closeVendorDetailsBtn" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">Vendor Code:</dt>
                                        <dd class="col-sm-8" id="detailVendorCode"></dd>
                                        
                                        <dt class="col-sm-4">Name:</dt>
                                        <dd class="col-sm-8" id="detailVendorName"></dd>
                                        
                                        <dt class="col-sm-4">Tax ID:</dt>
                                        <dd class="col-sm-8" id="detailTaxId"></dd>
                                        
                                        <dt class="col-sm-4">Contact:</dt>
                                        <dd class="col-sm-8" id="detailContactName"></dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">Email:</dt>
                                        <dd class="col-sm-8" id="detailEmail"></dd>
                                        
                                        <dt class="col-sm-4">Phone:</dt>
                                        <dd class="col-sm-8" id="detailPhone"></dd>
                                        
                                        <dt class="col-sm-4">Address:</dt>
                                        <dd class="col-sm-8" id="detailAddress"></dd>
                                        
                                        <dt class="col-sm-4">Status:</dt>
                                        <dd class="col-sm-8" id="detailVendorStatus"></dd>
                                    </dl>
                                </div>
                            </div>
                            
                            <h4 class="mt-4">Bank Accounts</h4>
                            <div id="bankAccountsContainer" class="row">
                                <!-- Bank account cards will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NACHA SETTINGS TAB -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h2>NACHA Settings</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createNachaSettingsModal">
                        <i class="fas fa-plus"></i> New NACHA Configuration
                    </button>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="settingsSearchInput" placeholder="Search settings...">
                            <button class="btn btn-outline-secondary" type="button" id="settingsSearchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-outline-secondary" id="refreshSettingsBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="nachaSettingsTable">
                        <thead>
                            <tr>
                                <th>Company Name</th>
                                <th>Company ID</th>
                                <th>Originating DFI ID</th>
                                <th>Entry Description</th>
                                <th>Settlement Account</th>
                                <th>Production Mode</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="nachaSettingsTableBody">
                            <!-- NACHA settings rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- NACHA FILES TAB -->
            <div class="tab-pane fade" id="files" role="tabpanel">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h2>NACHA Files</h2>
                    <button class="btn btn-outline-secondary" id="refreshFilesBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="nachaFilesTable">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Batch Number</th>
                                <th>File Date</th>
                                <th>Total Amount</th>
                                <th>Items</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="nachaFilesTableBody">
                            <!-- NACHA files rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Create Vendor Modal -->
    <div class="modal fade" id="createVendorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Vendor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createVendorForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="vendorCode" class="form-label">Vendor Code*</label>
                                <input type="text" class="form-control" id="vendorCode" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vendorName" class="form-label">Vendor Name*</label>
                                <input type="text" class="form-control" id="vendorName" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="taxId" class="form-label">Tax ID</label>
                                <input type="text" class="form-control" id="taxId">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vendorType" class="form-label">Vendor Type</label>
                                <select class="form-select" id="vendorType">
                                    <option value="supplier">Supplier</option>
                                    <option value="contractor">Contractor</option>
                                    <option value="employee">Employee</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="contactName" class="form-label">Contact Name</label>
                                <input type="text" class="form-control" id="contactName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="phone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="entityId" class="form-label">Entity</label>
                                <select class="form-select" id="entityId">
                                    <option value="">-- Select Entity --</option>
                                    <!-- Entities will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="addressLine1" class="form-label">Address Line 1</label>
                            <input type="text" class="form-control" id="addressLine1">
                        </div>
                        
                        <div class="mb-3">
                            <label for="addressLine2" class="form-label">Address Line 2</label>
                            <input type="text" class="form-control" id="addressLine2">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="postalCode" class="form-label">Postal Code</label>
                                <input type="text" class="form-control" id="postalCode">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="country" class="form-label">Country</label>
                                <input type="text" class="form-control" id="country" value="USA">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vendorStatus" class="form-label">Status</label>
                                <select class="form-select" id="vendorStatus">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveVendorBtn">Save Vendor</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Vendor Modal -->
    <div class="modal fade" id="editVendorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Vendor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editVendorForm">
                        <input type="hidden" id="editVendorId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editVendorCode" class="form-label">Vendor Code*</label>
                                <input type="text" class="form-control" id="editVendorCode" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editVendorName" class="form-label">Vendor Name*</label>
                                <input type="text" class="form-control" id="editVendorName" required>
                            </div>
                        </div>
                        
                        <!-- Same fields as create vendor form, but with "edit" prefix -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editTaxId" class="form-label">Tax ID</label>
                                <input type="text" class="form-control" id="editTaxId">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editVendorType" class="form-label">Vendor Type</label>
                                <select class="form-select" id="editVendorType">
                                    <option value="supplier">Supplier</option>
                                    <option value="contractor">Contractor</option>
                                    <option value="employee">Employee</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editContactName" class="form-label">Contact Name</label>
                                <input type="text" class="form-control" id="editContactName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editPhone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="editPhone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editEntityId" class="form-label">Entity</label>
                                <select class="form-select" id="editEntityId">
                                    <option value="">-- Select Entity --</option>
                                    <!-- Entities will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editAddressLine1" class="form-label">Address Line 1</label>
                            <input type="text" class="form-control" id="editAddressLine1">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editAddressLine2" class="form-label">Address Line 2</label>
                            <input type="text" class="form-control" id="editAddressLine2">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="editCity" class="form-label">City</label>
                                <input type="text" class="form-control" id="editCity">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editState" class="form-label">State</label>
                                <input type="text" class="form-control" id="editState">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editPostalCode" class="form-label">Postal Code</label>
                                <input type="text" class="form-control" id="editPostalCode">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editCountry" class="form-label">Country</label>
                                <input type="text" class="form-control" id="editCountry">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editVendorStatus" class="form-label">Status</label>
                                <select class="form-select" id="editVendorStatus">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="editNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateVendorBtn">Update Vendor</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Bank Account Modal -->
    <div class="modal fade" id="createBankAccountModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Bank Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createBankAccountForm">
                        <input type="hidden" id="bankAccountVendorId">
                        
                        <div class="mb-3">
                            <label for="accountName" class="form-label">Account Name*</label>
                            <input type="text" class="form-control" id="accountName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="routingNumber" class="form-label">Routing Number*</label>
                            <input type="text" class="form-control" id="routingNumber" required maxlength="9" pattern="\d{9}">
                            <div class="form-text">9-digit ABA routing number</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="accountNumber" class="form-label">Account Number*</label>
                            <input type="text" class="form-control" id="accountNumber" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="accountType" class="form-label">Account Type*</label>
                            <select class="form-select" id="accountType" required>
                                <option value="checking">Checking</option>
                                <option value="savings">Savings</option>
                            </select>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isPrimary">
                            <label class="form-check-label" for="isPrimary">Primary Account</label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="bankAccountStatus" class="form-label">Status</label>
                            <select class="form-select" id="bankAccountStatus">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBankAccountBtn">Save Bank Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Bank Account Modal -->
    <div class="modal fade" id="editBankAccountModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Bank Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editBankAccountForm">
                        <input type="hidden" id="editBankAccountId">
                        
                        <div class="mb-3">
                            <label for="editAccountName" class="form-label">Account Name*</label>
                            <input type="text" class="form-control" id="editAccountName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editRoutingNumber" class="form-label">Routing Number*</label>
                            <input type="text" class="form-control" id="editRoutingNumber" required maxlength="9" pattern="\d{9}">
                            <div class="form-text">9-digit ABA routing number</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editAccountNumber" class="form-label">Account Number*</label>
                            <input type="text" class="form-control" id="editAccountNumber" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editAccountType" class="form-label">Account Type*</label>
                            <select class="form-select" id="editAccountType" required>
                                <option value="checking">Checking</option>
                                <option value="savings">Savings</option>
                            </select>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editIsPrimary">
                            <label class="form-check-label" for="editIsPrimary">Primary Account</label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editBankAccountStatus" class="form-label">Status</label>
                            <select class="form-select" id="editBankAccountStatus">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateBankAccountBtn">Update Bank Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Batch Modal -->
    <div class="modal fade" id="createBatchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Payment Batch</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createBatchForm">
                        <div class="mb-3">
                            <label for="batchEntityId" class="form-label">Entity*</label>
                            <select class="form-select" id="batchEntityId" required>
                                <option value="">-- Select Entity --</option>
                                <!-- Entities will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="batchFundId" class="form-label">Fund</label>
                            <select class="form-select" id="batchFundId">
                                <option value="">-- Select Fund --</option>
                                <!-- Funds will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="nachaSettingsId" class="form-label">NACHA Settings*</label>
                            <select class="form-select" id="nachaSettingsId" required>
                                <option value="">-- Select NACHA Configuration --</option>
                                <!-- NACHA settings will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="batchDate" class="form-label">Batch Date*</label>
                            <input type="date" class="form-control" id="batchDate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="effectiveDate" class="form-label">Effective Date*</label>
                            <input type="date" class="form-control" id="effectiveDate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="batchDescription" class="form-label">Description*</label>
                            <input type="text" class="form-control" id="batchDescription" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBatchBtn">Create Batch</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Payment Item Modal -->
    <div class="modal fade" id="addPaymentItemModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Payment Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPaymentItemForm">
                        <input type="hidden" id="paymentBatchId">
                        
                        <div class="mb-3">
                            <label for="paymentVendorId" class="form-label">Vendor*</label>
                            <select class="form-select" id="paymentVendorId" required>
                                <option value="">-- Select Vendor --</option>
                                <!-- Vendors will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="vendorBankAccountId" class="form-label">Bank Account*</label>
                            <select class="form-select" id="vendorBankAccountId" required>
                                <option value="">-- Select Bank Account --</option>
                                <!-- Bank accounts will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="paymentAmount" class="form-label">Amount*</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="paymentAmount" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="paymentMemo" class="form-label">Memo</label>
                            <input type="text" class="form-control" id="paymentMemo" maxlength="80">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="invoiceNumber" class="form-label">Invoice Number</label>
                                <input type="text" class="form-control" id="invoiceNumber">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="invoiceDate" class="form-label">Invoice Date</label>
                                <input type="date" class="form-control" id="invoiceDate">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dueDate" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="dueDate">
                        </div>
                        
                        <div class="mb-3">
                            <label for="addenda" class="form-label">Addenda Information</label>
                            <textarea class="form-control" id="addenda" rows="2" maxlength="80"></textarea>
                            <div class="form-text">Optional additional information to include with the payment (max 80 characters)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="savePaymentItemBtn">Add Payment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Payment Item Modal -->
    <div class="modal fade" id="editPaymentItemModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Payment Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editPaymentItemForm">
                        <input type="hidden" id="editPaymentItemId">
                        
                        <div class="mb-3">
                            <label for="editPaymentVendorId" class="form-label">Vendor*</label>
                            <select class="form-select" id="editPaymentVendorId" required>
                                <option value="">-- Select Vendor --</option>
                                <!-- Vendors will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editVendorBankAccountId" class="form-label">Bank Account*</label>
                            <select class="form-select" id="editVendorBankAccountId" required>
                                <option value="">-- Select Bank Account --</option>
                                <!-- Bank accounts will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editPaymentAmount" class="form-label">Amount*</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="editPaymentAmount" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editPaymentMemo" class="form-label">Memo</label>
                            <input type="text" class="form-control" id="editPaymentMemo" maxlength="80">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editInvoiceNumber" class="form-label">Invoice Number</label>
                                <input type="text" class="form-control" id="editInvoiceNumber">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editInvoiceDate" class="form-label">Invoice Date</label>
                                <input type="date" class="form-control" id="editInvoiceDate">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editDueDate" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="editDueDate">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editAddenda" class="form-label">Addenda Information</label>
                            <textarea class="form-control" id="editAddenda" rows="2" maxlength="80"></textarea>
                            <div class="form-text">Optional additional information to include with the payment (max 80 characters)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updatePaymentItemBtn">Update Payment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create NACHA Settings Modal -->
    <div class="modal fade" id="createNachaSettingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create NACHA Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createNachaSettingsForm">
                        <div class="mb-3">
                            <label for="settingsEntityId" class="form-label">Entity</label>
                            <select class="form-select" id="settingsEntityId">
                                <option value="">-- Select Entity --</option>
                                <!-- Entities will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="companyName" class="form-label">Company Name*</label>
                            <input type="text" class="form-control" id="companyName" required maxlength="16">
                            <div class="form-text">Max 16 characters (NACHA requirement)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="companyId" class="form-label">Company ID*</label>
                            <input type="text" class="form-control" id="companyId" required maxlength="10">
                            <div class="form-text">Tax ID or NACHA assigned ID (max 10 digits)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="originatingDfiId" class="form-label">Originating DFI ID*</label>
                            <input type="text" class="form-control" id="originatingDfiId" required maxlength="8" pattern="\d{8}">
                            <div class="form-text">First 8 digits of your bank's routing number</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="companyEntryDescription" class="form-label">Company Entry Description*</label>
                            <input type="text" class="form-control" id="companyEntryDescription" required maxlength="10">
                            <div class="form-text">Description that appears on receiver's bank statement (e.g., PAYROLL, VENDOR)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="settlementAccountId" class="form-label">Settlement Account</label>
                            <select class="form-select" id="settlementAccountId">
                                <option value="">-- Select Bank Account --</option>
                                <!-- Bank accounts will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isProduction">
                            <label class="form-check-label" for="isProduction">Production Mode</label>
                            <div class="form-text">Check for production files, uncheck for test files</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNachaSettingsBtn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit NACHA Settings Modal -->
    <div class="modal fade" id="editNachaSettingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit NACHA Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editNachaSettingsForm">
                        <input type="hidden" id="editNachaSettingsId">
                        
                        <div class="mb-3">
                            <label for="editSettingsEntityId" class="form-label">Entity</label>
                            <select class="form-select" id="editSettingsEntityId">
                                <option value="">-- Select Entity --</option>
                                <!-- Entities will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editCompanyName" class="form-label">Company Name*</label>
                            <input type="text" class="form-control" id="editCompanyName" required maxlength="16">
                            <div class="form-text">Max 16 characters (NACHA requirement)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editCompanyId" class="form-label">Company ID*</label>
                            <input type="text" class="form-control" id="editCompanyId" required maxlength="10">
                            <div class="form-text">Tax ID or NACHA assigned ID (max 10 digits)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editOriginatingDfiId" class="form-label">Originating DFI ID*</label>
                            <input type="text" class="form-control" id="editOriginatingDfiId" required maxlength="8" pattern="\d{8}">
                            <div class="form-text">First 8 digits of your bank's routing number</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editCompanyEntryDescription" class="form-label">Company Entry Description*</label>
                            <input type="text" class="form-control" id="editCompanyEntryDescription" required maxlength="10">
                            <div class="form-text">Description that appears on receiver's bank statement (e.g., PAYROLL, VENDOR)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editSettlementAccountId" class="form-label">Settlement Account</label>
                            <select class="form-select" id="editSettlementAccountId">
                                <option value="">-- Select Bank Account --</option>
                                <!-- Bank accounts will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editIsProduction">
                            <label class="form-check-label" for="editIsProduction">Production Mode</label>
                            <div class="form-text">Check for production files, uncheck for test files</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateNachaSettingsBtn">Update Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationTitle">Confirmation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmationMessage">Are you sure you want to proceed?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Operation completed successfully.
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentVendor = null;
        let currentBatch = null;
        let entities = [];
        let funds = [];
        let bankAccounts = [];
        let vendors = [];
        let nachaSettings = [];
        
        // Utility functions
        function showLoading() {
            document.querySelector('.loading-overlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.querySelector('.loading-overlay').style.display = 'none';
        }
        
        function showToast(title, message, isError = false) {
            const toast = document.getElementById('toastNotification');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            if (isError) {
                toast.classList.add('bg-danger', 'text-white');
            } else {
                toast.classList.remove('bg-danger', 'text-white');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US');
        }
        
        function maskAccountNumber(accountNumber) {
            if (!accountNumber) return '';
            const visible = accountNumber.slice(-4);
            const masked = 'X'.repeat(accountNumber.length - 4);
            return masked + visible;
        }
        
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'draft': return 'bg-secondary';
                case 'pending_approval': return 'bg-warning';
                case 'approved': return 'bg-success';
                case 'processed': return 'bg-primary';
                case 'transmitted': return 'bg-info';
                case 'confirmed': return 'bg-success';
                case 'rejected': return 'bg-danger';
                case 'error': return 'bg-danger';
                case 'active': return 'bg-success';
                case 'inactive': return 'bg-secondary';
                case 'suspended': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }
        
        // API Calls
        async function fetchEntities() {
            try {
                const response = await fetch('/api/entities');
                entities = await response.json();
                
                // Populate entity dropdowns
                const entitySelects = [
                    document.getElementById('entityId'),
                    document.getElementById('editEntityId'),
                    document.getElementById('batchEntityId'),
                    document.getElementById('settingsEntityId'),
                    document.getElementById('editSettingsEntityId')
                ];
                
                entitySelects.forEach(select => {
                    if (!select) return;
                    
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add entity options
                    entities.forEach(entity => {
                        const option = document.createElement('option');
                        option.value = entity.id;
                        option.textContent = entity.name;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error fetching entities:', error);
                showToast('Error', 'Failed to load entities', true);
            }
        }
        
        async function fetchFunds(entityId = null) {
            try {
                const url = entityId ? `/api/funds?entityId=${entityId}` : '/api/funds';
                const response = await fetch(url);
                funds = await response.json();
                
                // Populate fund dropdowns
                const fundSelects = [
                    document.getElementById('batchFundId')
                ];
                
                fundSelects.forEach(select => {
                    if (!select) return;
                    
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add fund options
                    funds.forEach(fund => {
                        const option = document.createElement('option');
                        option.value = fund.id;
                        option.textContent = fund.name;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error fetching funds:', error);
                showToast('Error', 'Failed to load funds', true);
            }
        }
        
        async function fetchBankAccounts() {
            try {
                const response = await fetch('/api/bank-accounts');
                bankAccounts = await response.json();
                
                // Populate bank account dropdowns
                const bankAccountSelects = [
                    document.getElementById('settlementAccountId'),
                    document.getElementById('editSettlementAccountId')
                ];
                
                bankAccountSelects.forEach(select => {
                    if (!select) return;
                    
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add bank account options
                    bankAccounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.textContent = `${account.account_name} (${account.bank_name})`;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error fetching bank accounts:', error);
                // This might be a new feature, so don't show error if endpoint doesn't exist yet
                if (error.message !== 'Failed to fetch') {
                    showToast('Error', 'Failed to load bank accounts', true);
                }
            }
        }
        
        async function fetchVendors() {
            try {
                showLoading();
                const response = await fetch('/api/vendors');
                vendors = await response.json();
                renderVendorsTable();
                
                // Populate vendor dropdowns
                const vendorSelects = [
                    document.getElementById('paymentVendorId'),
                    document.getElementById('editPaymentVendorId')
                ];
                
                vendorSelects.forEach(select => {
                    if (!select) return;
                    
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add vendor options
                    vendors.forEach(vendor => {
                        const option = document.createElement('option');
                        option.value = vendor.id;
                        option.textContent = `${vendor.name} (${vendor.vendor_code})`;
                        select.appendChild(option);
                    });
                });
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error fetching vendors:', error);
                showToast('Error', 'Failed to load vendors', true);
            }
        }
        
        async function fetchVendorBankAccounts(vendorId, targetSelect) {
            try {
                const response = await fetch(`/api/vendors/${vendorId}/bank-accounts`);
                const bankAccounts = await response.json();
                
                // Clear existing options except the first one
                while (targetSelect.options.length > 1) {
                    targetSelect.remove(1);
                }
                
                // Add bank account options
                bankAccounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.account_name} - ${account.account_type} (${maskAccountNumber(account.account_number)})`;
                    if (account.is_primary) {
                        option.textContent += ' (Primary)';
                        option.selected = true;
                    }
                    targetSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching vendor bank accounts:', error);
                showToast('Error', 'Failed to load vendor bank accounts', true);
            }
        }
        
        async function fetchNachaSettings() {
            try {
                const response = await fetch('/api/nacha-settings');
                nachaSettings = await response.json();
                renderNachaSettingsTable();
                
                // Populate NACHA settings dropdowns
                const settingsSelects = [
                    document.getElementById('nachaSettingsId')
                ];
                
                settingsSelects.forEach(select => {
                    if (!select) return;
                    
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add settings options
                    nachaSettings.forEach(setting => {
                        const option = document.createElement('option');
                        option.value = setting.id;
                        option.textContent = `${setting.company_name} (${setting.company_entry_description})`;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error fetching NACHA settings:', error);
                showToast('Error', 'Failed to load NACHA settings', true);
            }
        }
        
        async function fetchBatches() {
            try {
                showLoading();
                const statusFilter = document.getElementById('batchStatusFilter').value;
                const url = statusFilter ? `/api/payment-batches?status=${statusFilter}` : '/api/payment-batches';
                const response = await fetch(url);
                const batches = await response.json();
                renderBatchesTable(batches);
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error fetching payment batches:', error);
                showToast('Error', 'Failed to load payment batches', true);
            }
        }
        
        async function fetchBatchDetails(batchId) {
            try {
                showLoading();
                const response = await fetch(`/api/payment-batches/${batchId}`);
                currentBatch = await response.json();
                
                // Fetch payment items for this batch
                const itemsResponse = await fetch(`/api/payment-batches/${batchId}/items`);
                const items = await itemsResponse.json();
                
                renderBatchDetails(currentBatch, items);
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error fetching batch details:', error);
                showToast('Error', 'Failed to load batch details', true);
            }
        }
        
        async function fetchVendorDetails(vendorId) {
            try {
                showLoading();
                const response = await fetch(`/api/vendors/${vendorId}`);
                currentVendor = await response.json();
                
                // Fetch bank accounts for this vendor
                const bankAccountsResponse = await fetch(`/api/vendors/${vendorId}/bank-accounts`);
                const bankAccounts = await bankAccountsResponse.json();
                
                renderVendorDetails(currentVendor, bankAccounts);
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error fetching vendor details:', error);
                showToast('Error', 'Failed to load vendor details', true);
            }
        }
        
        async function fetchNachaFiles() {
            try {
                showLoading();
                const response = await fetch('/api/nacha-files');
                const files = await response.json();
                renderNachaFilesTable(files);
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error fetching NACHA files:', error);
                showToast('Error', 'Failed to load NACHA files', true);
            }
        }
        
        // Render Functions
        function renderVendorsTable() {
            const tableBody = document.getElementById('vendorsTableBody');
            tableBody.innerHTML = '';
            
            if (vendors.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" class="text-center">No vendors found</td>';
                tableBody.appendChild(row);
                return;
            }
            
            vendors.forEach(vendor => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vendor.vendor_code}</td>
                    <td>${vendor.name}</td>
                    <td>${vendor.contact_name || ''}</td>
                    <td>${vendor.email || ''}</td>
                    <td>${vendor.phone || ''}</td>
                    <td><span class="badge bg-info">${vendor.bank_account_count || '0'}</span></td>
                    <td><span class="badge ${getStatusBadgeClass(vendor.status)}">${vendor.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-vendor-btn" data-vendor-id="${vendor.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary edit-vendor-btn" data-vendor-id="${vendor.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-vendor-btn" data-vendor-id="${vendor.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-vendor-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const vendorId = btn.getAttribute('data-vendor-id');
                    fetchVendorDetails(vendorId);
                });
            });
            
            document.querySelectorAll('.edit-vendor-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const vendorId = btn.getAttribute('data-vendor-id');
                    const vendor = vendors.find(v => v.id === vendorId);
                    if (vendor) {
                        populateEditVendorForm(vendor);
                        const modal = new bootstrap.Modal(document.getElementById('editVendorModal'));
                        modal.show();
                    }
                });
            });
            
            document.querySelectorAll('.delete-vendor-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const vendorId = btn.getAttribute('data-vendor-id');
                    const vendor = vendors.find(v => v.id === vendorId);
                    if (vendor) {
                        showDeleteVendorConfirmation(vendor);
                    }
                });
            });
        }
        
        function renderVendorDetails(vendor, bankAccounts) {
            // Show vendor details section
            document.getElementById('vendorDetailsSection').style.display = 'block';
            
            // Set vendor details
            document.getElementById('vendorDetailsTitle').textContent = `${vendor.name} (${vendor.vendor_code})`;
            document.getElementById('detailVendorCode').textContent = vendor.vendor_code;
            document.getElementById('detailVendorName').textContent = vendor.name;
            document.getElementById('detailTaxId').textContent = vendor.tax_id || 'N/A';
            document.getElementById('detailContactName').textContent = vendor.contact_name || 'N/A';
            document.getElementById('detailEmail').textContent = vendor.email || 'N/A';
            document.getElementById('detailPhone').textContent = vendor.phone || 'N/A';
            
            // Format address
            let address = vendor.address_line1 || '';
            if (vendor.address_line2) address += `<br>${vendor.address_line2}`;
            if (vendor.city || vendor.state || vendor.postal_code) {
                address += `<br>${vendor.city || ''}, ${vendor.state || ''} ${vendor.postal_code || ''}`;
            }
            if (vendor.country) address += `<br>${vendor.country}`;
            document.getElementById('detailAddress').innerHTML = address || 'N/A';
            
            document.getElementById('detailVendorStatus').innerHTML = `<span class="badge ${getStatusBadgeClass(vendor.status)}">${vendor.status}</span>`;
            
            // Render bank accounts
            const bankAccountsContainer = document.getElementById('bankAccountsContainer');
            bankAccountsContainer.innerHTML = '';
            
            if (bankAccounts.length === 0) {
                bankAccountsContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">No bank accounts found</div></div>';
                return;
            }
            
            bankAccounts.forEach(account => {
                const card = document.createElement('div');
                card.className = `col-md-6 mb-3`;
                card.innerHTML = `
                    <div class="card bank-account-card ${account.is_primary ? 'primary' : ''}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">${account.account_name} ${account.is_primary ? '<span class="badge bg-success">Primary</span>' : ''}</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary edit-bank-account-btn" data-account-id="${account.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-bank-account-btn" data-account-id="${account.id}">
                                    <i class="fas fa-trash"></i>
                                                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-5">Account Type:</dt>
                                <dd class="col-sm-7">${account.account_type.charAt(0).toUpperCase() + account.account_type.slice(1)}</dd>
                                
                                <dt class="col-sm-5">Routing Number:</dt>
                                <dd class="col-sm-7"><span class="badge-account">${account.routing_number}</span></dd>
                                
                                <dt class="col-sm-5">Account Number:</dt>
                                <dd class="col-sm-7"><span class="account-number-masked">${maskAccountNumber(account.account_number)}</span></dd>
                                
                                <dt class="col-sm-5">Status:</dt>
                                <dd class="col-sm-7"><span class="badge ${getStatusBadgeClass(account.status)}">${account.status}</span></dd>
                            </dl>
                        </div>
                    </div>
                `;
                bankAccountsContainer.appendChild(card);
            });
            
            // Add event listeners
            document.querySelectorAll('.edit-bank-account-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const accountId = btn.getAttribute('data-account-id');
                    const account = bankAccounts.find(a => a.id === accountId);
                    if (account) {
                        populateEditBankAccountForm(account);
                        const modal = new bootstrap.Modal(document.getElementById('editBankAccountModal'));
                        modal.show();
                    }
                });
            });
            
            document.querySelectorAll('.delete-bank-account-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const accountId = btn.getAttribute('data-account-id');
                    const account = bankAccounts.find(a => a.id === accountId);
                    if (account) {
                        showDeleteBankAccountConfirmation(account);
                    }
                });
            });
        }
        
        function renderNachaSettingsTable() {
            const tableBody = document.getElementById('nachaSettingsTableBody');
            tableBody.innerHTML = '';
            
            if (nachaSettings.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" class="text-center">No NACHA settings found</td>';
                tableBody.appendChild(row);
                return;
            }
            
            nachaSettings.forEach(setting => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${setting.company_name}</td>
                    <td>${setting.company_id}</td>
                    <td>${setting.originating_dfi_id}</td>
                    <td>${setting.company_entry_description}</td>
                    <td>${setting.settlement_account_name || 'N/A'}</td>
                    <td>${setting.is_production ? '<span class="badge bg-success">Production</span>' : '<span class="badge bg-warning">Test</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary edit-nacha-settings-btn" data-settings-id="${setting.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-nacha-settings-btn" data-settings-id="${setting.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.edit-nacha-settings-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const settingsId = btn.getAttribute('data-settings-id');
                    const settings = nachaSettings.find(s => s.id === settingsId);
                    if (settings) {
                        populateEditNachaSettingsForm(settings);
                        const modal = new bootstrap.Modal(document.getElementById('editNachaSettingsModal'));
                        modal.show();
                    }
                });
            });
            
            document.querySelectorAll('.delete-nacha-settings-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const settingsId = btn.getAttribute('data-settings-id');
                    const settings = nachaSettings.find(s => s.id === settingsId);
                    if (settings) {
                        showDeleteNachaSettingsConfirmation(settings);
                    }
                });
            });
        }
        
        function renderBatchesTable(batches) {
            const tableBody = document.getElementById('batchesTableBody');
            tableBody.innerHTML = '';
            
            if (batches.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" class="text-center">No payment batches found</td>';
                tableBody.appendChild(row);
                return;
            }
            
            batches.forEach(batch => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${batch.batch_number}</td>
                    <td>${formatDate(batch.batch_date)}</td>
                    <td>${batch.description}</td>
                    <td>${batch.entity_name || 'N/A'}</td>
                    <td>${formatCurrency(batch.total_amount)}</td>
                    <td>${batch.total_items}</td>
                    <td><span class="badge ${getStatusBadgeClass(batch.status)}">${batch.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-batch-btn" data-batch-id="${batch.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${batch.status === 'draft' ? `
                        <button class="btn btn-sm btn-outline-secondary edit-batch-btn" data-batch-id="${batch.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-batch-btn" data-batch-id="${batch.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-batch-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const batchId = btn.getAttribute('data-batch-id');
                    fetchBatchDetails(batchId);
                });
            });
            
            document.querySelectorAll('.edit-batch-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const batchId = btn.getAttribute('data-batch-id');
                    // Implement edit batch functionality
                });
            });
            
            document.querySelectorAll('.delete-batch-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const batchId = btn.getAttribute('data-batch-id');
                    const batch = batches.find(b => b.id === batchId);
                    if (batch) {
                        showDeleteBatchConfirmation(batch);
                    }
                });
            });
        }
        
        function renderBatchDetails(batch, items) {
            // Show batch details section
            document.getElementById('batchDetailsSection').style.display = 'block';
            
            // Set batch details
            document.getElementById('batchDetailsTitle').textContent = `Batch: ${batch.batch_number}`;
            document.getElementById('detailBatchNumber').textContent = batch.batch_number;
            document.getElementById('detailDescription').textContent = batch.description;
            document.getElementById('detailEntity').textContent = batch.entity_name || 'N/A';
            document.getElementById('detailFund').textContent = batch.fund_name || 'N/A';
            document.getElementById('detailBatchDate').textContent = formatDate(batch.batch_date);
            document.getElementById('detailEffectiveDate').textContent = formatDate(batch.effective_date);
            document.getElementById('detailStatus').innerHTML = `<span class="badge ${getStatusBadgeClass(batch.status)}">${batch.status}</span>`;
            document.getElementById('detailNachaCompany').textContent = batch.nacha_company_name || 'N/A';
            
            // Show/hide action buttons based on status
            document.getElementById('approveBatchBtn').style.display = batch.status === 'draft' || batch.status === 'pending_approval' ? 'inline-block' : 'none';
            document.getElementById('generateNachaBtn').style.display = batch.status === 'approved' ? 'inline-block' : 'none';
            document.getElementById('addPaymentItemBtn').style.display = batch.status === 'draft' ? 'inline-block' : 'none';
            
            // Render payment items
            const tableBody = document.getElementById('paymentItemsTableBody');
            tableBody.innerHTML = '';
            
            if (items.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" class="text-center">No payment items found</td>';
                tableBody.appendChild(row);
                document.getElementById('paymentItemsTotal').textContent = formatCurrency(0);
                return;
            }
            
            let totalAmount = 0;
            items.forEach(item => {
                totalAmount += parseFloat(item.amount);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.vendor_name}</td>
                    <td>${item.account_name} (${item.account_type})</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>${item.memo || ''}</td>
                    <td>${item.invoice_number || ''}</td>
                    <td><span class="badge ${getStatusBadgeClass(item.status)}">${item.status}</span></td>
                    <td>
                        ${batch.status === 'draft' ? `
                        <button class="btn btn-sm btn-outline-secondary edit-payment-item-btn" data-item-id="${item.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-payment-item-btn" data-item-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            document.getElementById('paymentItemsTotal').textContent = formatCurrency(totalAmount);
            
            // Add event listeners
            document.querySelectorAll('.edit-payment-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const itemId = btn.getAttribute('data-item-id');
                    const item = items.find(i => i.id === itemId);
                    if (item) {
                        populateEditPaymentItemForm(item);
                        const modal = new bootstrap.Modal(document.getElementById('editPaymentItemModal'));
                        modal.show();
                    }
                });
            });
            
            document.querySelectorAll('.delete-payment-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const itemId = btn.getAttribute('data-item-id');
                    const item = items.find(i => i.id === itemId);
                    if (item) {
                        showDeletePaymentItemConfirmation(item);
                    }
                });
            });
        }
        
        function renderNachaFilesTable(files) {
            const tableBody = document.getElementById('nachaFilesTableBody');
            tableBody.innerHTML = '';
            
            if (files.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" class="text-center">No NACHA files found</td>';
                tableBody.appendChild(row);
                return;
            }
            
            files.forEach(file => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${file.file_name}</td>
                    <td>${file.batch_number || 'N/A'}</td>
                    <td>${formatDate(file.file_date)}</td>
                    <td>${formatCurrency(file.total_amount)}</td>
                    <td>${file.total_items}</td>
                    <td><span class="badge ${getStatusBadgeClass(file.status)}">${file.status}</span></td>
                    <td>
                        <a href="/api/nacha-files/${file.id}/download" class="btn btn-sm btn-outline-primary" download>
                            <i class="fas fa-download"></i> Download
                        </a>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Form Helpers
        function populateEditVendorForm(vendor) {
            document.getElementById('editVendorId').value = vendor.id;
            document.getElementById('editVendorCode').value = vendor.vendor_code;
            document.getElementById('editVendorName').value = vendor.name;
            document.getElementById('editTaxId').value = vendor.tax_id || '';
            document.getElementById('editVendorType').value = vendor.vendor_type || 'supplier';
            document.getElementById('editContactName').value = vendor.contact_name || '';
            document.getElementById('editEmail').value = vendor.email || '';
            document.getElementById('editPhone').value = vendor.phone || '';
            document.getElementById('editEntityId').value = vendor.entity_id || '';
            document.getElementById('editAddressLine1').value = vendor.address_line1 || '';
            document.getElementById('editAddressLine2').value = vendor.address_line2 || '';
            document.getElementById('editCity').value = vendor.city || '';
            document.getElementById('editState').value = vendor.state || '';
            document.getElementById('editPostalCode').value = vendor.postal_code || '';
            document.getElementById('editCountry').value = vendor.country || 'USA';
            document.getElementById('editVendorStatus').value = vendor.status || 'active';
            document.getElementById('editNotes').value = vendor.notes || '';
        }
        
        function populateEditBankAccountForm(account) {
            document.getElementById('editBankAccountId').value = account.id;
            document.getElementById('editAccountName').value = account.account_name;
            document.getElementById('editRoutingNumber').value = account.routing_number;
            document.getElementById('editAccountNumber').value = account.account_number;
            document.getElementById('editAccountType').value = account.account_type;
            document.getElementById('editIsPrimary').checked = account.is_primary;
            document.getElementById('editBankAccountStatus').value = account.status || 'active';
        }
        
        function populateEditNachaSettingsForm(settings) {
            document.getElementById('editNachaSettingsId').value = settings.id;
            document.getElementById('editSettingsEntityId').value = settings.entity_id || '';
            document.getElementById('editCompanyName').value = settings.company_name;
            document.getElementById('editCompanyId').value = settings.company_id;
            document.getElementById('editOriginatingDfiId').value = settings.originating_dfi_id;
            document.getElementById('editCompanyEntryDescription').value = settings.company_entry_description;
            document.getElementById('editSettlementAccountId').value = settings.settlement_account_id || '';
            document.getElementById('editIsProduction').checked = settings.is_production;
        }
        
        function populateEditPaymentItemForm(item) {
            document.getElementById('editPaymentItemId').value = item.id;
            document.getElementById('editPaymentVendorId').value = item.vendor_id;
            
            // Fetch bank accounts for this vendor
            fetchVendorBankAccounts(item.vendor_id, document.getElementById('editVendorBankAccountId'))
                .then(() => {
                    // Set the selected bank account after accounts are loaded
                    document.getElementById('editVendorBankAccountId').value = item.vendor_bank_account_id;
                });
            
            document.getElementById('editPaymentAmount').value = item.amount;
            document.getElementById('editPaymentMemo').value = item.memo || '';
            document.getElementById('editInvoiceNumber').value = item.invoice_number || '';
            document.getElementById('editInvoiceDate').value = item.invoice_date ? item.invoice_date.split('T')[0] : '';
            document.getElementById('editDueDate').value = item.due_date ? item.due_date.split('T')[0] : '';
            document.getElementById('editAddenda').value = item.addenda || '';
        }
        
        // Confirmation Dialogs
        function showDeleteVendorConfirmation(vendor) {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmationTitle').textContent = 'Delete Vendor';
            document.getElementById('confirmationMessage').textContent = `Are you sure you want to delete vendor "${vendor.name}"?`;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.onclick = async () => {
                try {
                    showLoading();
                    const response = await fetch(`/api/vendors/${vendor.id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to delete vendor');
                    }
                    
                    bootstrap.Modal.getInstance(modal).hide();
                    showToast('Success', 'Vendor deleted successfully');
                    fetchVendors();
                } catch (error) {
                    console.error('Error deleting vendor:', error);
                    showToast('Error', error.message, true);
                } finally {
                    hideLoading();
                }
            };
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        function showDeleteBankAccountConfirmation(account) {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmationTitle').textContent = 'Delete Bank Account';
            document.getElementById('confirmationMessage').textContent = `Are you sure you want to delete bank account "${account.account_name}"?`;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.onclick = async () => {
                try {
                    showLoading();
                    const response = await fetch(`/api/vendor-bank-accounts/${account.id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to delete bank account');
                    }
                    
                    bootstrap.Modal.getInstance(modal).hide();
                    showToast('Success', 'Bank account deleted successfully');
                    
                    // Refresh vendor details
                    if (currentVendor) {
                        fetchVendorDetails(currentVendor.id);
                    }
                } catch (error) {
                    console.error('Error deleting bank account:', error);
                    showToast('Error', error.message, true);
                } finally {
                    hideLoading();
                }
            };
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        function showDeleteNachaSettingsConfirmation(settings) {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmationTitle').textContent = 'Delete NACHA Settings';
            document.getElementById('confirmationMessage').textContent = `Are you sure you want to delete NACHA settings for "${settings.company_name}"?`;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.onclick = async () => {
                try {
                    showLoading();
                    const response = await fetch(`/api/nacha-settings/${settings.id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to delete NACHA settings');
                    }
                    
                    bootstrap.Modal.getInstance(modal).hide();
                    showToast('Success', 'NACHA settings deleted successfully');
                    fetchNachaSettings();
                } catch (error) {
                    console.error('Error deleting NACHA settings:', error);
                    showToast('Error', error.message, true);
                } finally {
                    hideLoading();
                }
            };
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        function showDeleteBatchConfirmation(batch) {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmationTitle').textContent = 'Delete Payment Batch';
            document.getElementById('confirmationMessage').textContent = `Are you sure you want to delete payment batch "${batch.batch_number}"?`;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.onclick = async () => {
                try {
                    showLoading();
                    const response = await fetch(`/api/payment-batches/${batch.id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to delete payment batch');
                    }
                    
                    bootstrap.Modal.getInstance(modal).hide();
                    showToast('Success', 'Payment batch deleted successfully');
                    fetchBatches();
                    
                    // Hide batch details if the current batch was deleted
                    if (currentBatch && currentBatch.id === batch.id) {
                        document.getElementById('batchDetailsSection').style.display = 'none';
                        currentBatch = null;
                    }
                } catch (error) {
                    console.error('Error deleting payment batch:', error);
                    showToast('Error', error.message, true);
                } finally {
                    hideLoading();
                }
            };
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        function showDeletePaymentItemConfirmation(item) {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmationTitle').textContent = 'Delete Payment Item';
            document.getElementById('confirmationMessage').textContent = `Are you sure you want to delete payment of ${formatCurrency(item.amount)} to "${item.vendor_name}"?`;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.onclick = async () => {
                try {
                    showLoading();
                    const response = await fetch(`/api/payment-items/${item.id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to delete payment item');
                    }
                    
                    bootstrap.Modal.getInstance(modal).hide();
                    showToast('Success', 'Payment item deleted successfully');
                    
                    // Refresh batch details
                    if (currentBatch) {
                        fetchBatchDetails(currentBatch.id);
                    }
                } catch (error) {
                    console.error('Error deleting payment item:', error);
                    showToast('Error', error.message, true);
                } finally {
                    hideLoading();
                }
            };
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // Form Submission Handlers
        async function handleCreateVendor() {
            try {
                const vendorData = {
                    entity_id: document.getElementById('entityId').value || null,
                    vendor_code: document.getElementById('vendorCode').value,
                    name: document.getElementById('vendorName').value,
                    tax_id: document.getElementById('taxId').value,
                    contact_name: document.getElementById('contactName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address_line1: document.getElementById('addressLine1').value,
                    address_line2: document.getElementById('addressLine2').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    postal_code: document.getElementById('postalCode').value,
                    country: document.getElementById('country').value,
                    vendor_type: document.getElementById('vendorType').value,
                    status: document.getElementById('vendorStatus').value,
                    notes: document.getElementById('notes').value
                };
                
                showLoading();
                const response = await fetch('/api/vendors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(vendorData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create vendor');
                }
                
                const vendor = await response.json();
                
                // Close modal and show success message
                bootstrap.Modal.getInstance(document.getElementById('createVendorModal')).hide();
                showToast('Success', 'Vendor created successfully');
                
                // Reset form
                document.getElementById('createVendorForm').reset();
                
                // Refresh vendors list
                fetchVendors();
                
                // Show the new vendor details
                fetchVendorDetails(vendor.id);
            } catch (error) {
                console.error('Error creating vendor:', error);
                showToast('Error', error.message, true);
            } finally {
                hideLoading();
            }
        }
        
        async function handleUpdateVendor() {
            try {
                const vendorId = document.getElementById('editVendorId').value;
                const vendorData = {
                    entity_id: document.getElementById('editEntityId').value || null,
                    vendor_code: document.getElementById('editVendorCode').value,
                    name: document.getElementById('editVendorName').value,
                    tax_id: document.getElementById('editTaxId').value,
                    contact_name: document.getElementById('editContactName').value,
                    email: document.getElementById('editEmail').value,
                    phone: document.getElementById('editPhone').value,
                    address_line1: document.getElementById('editAddressLine1').value,
                    address_line2: document.getElementById('editAddressLine2').value,
                    city: document.getElementById('editCity').value,
                    state: document.getElementById('editState').value,
                    postal_code: document.getElementById('editPostalCode').value,
                    country: document.getElementById('editCountry').value,
                    vendor_type: document.getElementById('editVendorType').value,
                    status: document.getElementById('editVendorStatus').value,
                    notes: document.getElementById('editNotes').value
                };
                
                showLoading();
                const response = await fetch(`/api/vendors/${vendorId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(vendorData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update vendor');
                }
                
                const vendor = await response.json();
                
                // Close modal and show success message
                bootstrap.Modal.getInstance(document.getElementById('editVendorModal')).hide();
                showToast('Success', 'Vendor updated successfully');
                
                // Refresh vendors list
                fetchVendors();
                
                // Update current vendor details if viewing this vendor
                if (currentVendor && currentVendor.id === vendorId) {
                    fetchVendorDetails(vendorId);
                }
            } catch (error) {
                console.error('Error updating vendor:', error);
                showToast('Error', error.message, true);
            } finally {
                hideLoading();
            }
        }
        
        async function handleCreateBankAccount() {
            try {
                const vendorId = document.getElementById('bankAccountVendorId').value;
                const bankAccountData = {
                    account_name: document.getElementById('accountName').value,
                    routing_number: document.getElementById('routingNumber').value,
                    account_number: document.getElementById('accountNumber').value,
                    account_type: document.getElementById('accountType').value,
                    is_primary: document.getElementById('isPrimary').checked,
                    status: document.getElementById('bankAccountStatus').value
                };
                
                showLoading();
                const response = await fetch(`/api/vendors/${vendorId}/bank-accounts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bankAccountData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create bank account');
                }
                
                // Close modal and show success message
                bootstrap.Modal.getInstance(document.getElementById('createBankAccountModal')).hide();
                showToast('Success', 'Bank account created successfully');
                
                // Reset form
                document.getElementById('createBankAccountForm').reset();
                
                // Refresh vendor details
                if (currentVendor) {
                    fetchVendorDetails(currentVendor.id);
                }
            } catch (error) {
                console.error('Error creating bank account:', error);
                showToast('Error', error.message, true);
            } finally {
                hideLoading();
            }
        }
        
        async function handleUpdateBankAccount() {
            try {
                const accountId = document.getElementById('editBankAccountId').value;
                const bankAccountData = {
                    account_name: document.getElementById('editAccountName').value,
                    routing_number: document.getElementById('editRoutingNumber').value,
                    account_number: document.getElementById('editAccountNumber').value,
                    account_type: document.getElementById('editAccountType').value,
                    is_primary: document.getElementById('editIsPrimary').checked,
                    status: document.getElementById('editBankAccountStatus').value
                };
                
                showLoading();
                const response = await fetch(`/api/vendor-bank-accounts/${accountId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bankAccountData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update bank account');
                }
                
                // Close modal and show success message
                bootstrap.Modal.getInstance(document.getElementById('editBankAccountModal')).hide();
                showToast('Success', 'Bank account updated successfully');
                
                // Refresh vendor details
                if (currentVendor) {
                    fetchVendorDetails(currentVendor.id);
                }
            } catch (error) {
                console.error('Error updating bank account:', error);
                showToast('Error', error.message, true);
            } finally {
                hideLoading();
            }
        }
        
        async function handleCreateBatch() {
            try {
                const batchData = {
                    entity_id: document.getElementById('batchEntityId').value,
                    fund_id: document.getElementById('batchFundId').value || null,
                    nacha_settings_id: document.getElementById('nachaSettingsId').value,
                    batch_date: document.getElementById('batchDate').value,
                    effective_date: document.getElementById('effectiveDate').value,
                    description: document.getElementById('batchDescription').value,
                    created_by: 'system' // In a real app, this would be the logged-in user's ID
                };
                
                showLoading();
                const response = await fetch('/api/payment-batches', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(batchData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create payment batch');
                }
                
                const batch = await response.json();
                
                // Close modal and show success message
                bootstrap.Modal.getInstance(document.getElementById('createBatchModal')).hide();
                showToast('Success', 'Payment batch created successfully');
                
                // Reset form
                document.getElementById('createBatchForm').reset();
                
                // Refresh batches list
                fetchBatches();
                
                // Show the new batch details
                fetchBatchDetails(batch.id);
            } catch (error) {
                console.error('Error creating payment batch:', error);
                showToast('Error', error.message, true);
            } finally {
                hideLoading();
            }
        }
        
        async function handleCreatePaymentItem() {
            try {
                const batchId = document.getElementById('paymentBatchId').value;
                const paymentItemData = {
                    vendor_id: document.getElementById('paymentVendorId').value,
                    vendor_bank_account_id: document.getElementById('vendorBankAccountId').value,
                    amount: document.getElementById('paymentAmount').value,
                    memo: document.getElementById('paymentMemo').value,
                    invoice_number: document.getElementById('invoiceNumber').value,
                    invoice_date: document.getElementById('invoiceDate').value || null,
                    due_date: document.getElementById('dueDate').value || null,
                    addenda: document.getElementById('addenda').value
                };
                
                showLoading();
                const response = await fetch(`/api/payment-batches/${batchId}/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentItemData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create payment item');
                }
                
                // Close modal and show success message
                bootstrap.Modal.getInstance(document.getElementById('addPaymentItemModal')).hide();
                showToast('Success', 'Payment item added successfully');
                
                // Reset form
                document.getElementById('addPaymentItemForm').reset();
                
                // Refresh batch details
                if (currentBatch) {
                    fetchBatchDetails(currentBatch.id);
                }
            } catch (error) {
                console.error('Error creating payment item:', error);
                showToast('Error', error.message, true);
            } finally {
                hideLoading();
            }
        }
        
        async function handleUpdatePaymentItem() {
            try {
                const itemId = document.getElementById('editPaymentItemId').value;
                const paymentItemData = {
                    vendor_id: document.getElementById('editPaymentVendorId').value,
                    vendor_bank_account_id: document.getElementById('editVendorBankAccountId').value,
                    amount: document.getElementById('editPaymentAmount').value,
                    memo: document.getElementById('editPaymentMemo').value,
                    invoice_number: document.getElementById('editInvoiceNumber').value,
                    invoice_date: document.getElementById('editInvoiceDate').value || null,
                    due_date: document.getElementById('editDueDate').value || null,
                    addenda: document.getElementById('editAddenda').value
                };
                
                showLoading();
                const response = await fetch(`/api/payment-items/${itemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentItemData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update payment item');
                }
                
                // Close modal and show success message
                bootstrap.Modal.getInstance(document.getElementById('editPaymentItemModal')).hide();
                showToast('Success', 'Payment item updated successfully');
                
                // Refresh batch details
                if (currentBatch) {
                    fetchBatchDetails(currentBatch.id);
                }
            } catch (error) {
                console.error('Error updating payment item:', error);
                showToast('Error', error.message, true);
            } finally {
                hideLoading();
            }
        }
        
        async function handleCreateNachaSettings() {
            try {
                const settingsData = {
                    entity_id: document.getElementById('settingsEntityId').value || null,
                    company_name: document.getElementById('companyName').value,
                    company_id: document.getElementById('companyId').value,
                    originating_dfi_id: document.getElementById('originatingDfiId').value,
                    company_entry_description: document.getElementById('companyEntryDescription').value,
                    settlement_account_id: document.getElementById('settlementAccountId').value || null,
                    is_production: document.getElementById('isProduction').checked
                };
                
                showLoading();
                const response = await fetch('/api/nacha-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settingsData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create NACHA settings');
                }
                
                // Close modal and show success message
                bootstrap.Modal.getInstance(document.getElementById('createNachaSettingsModal')).hide();
                showToast('Success', 'NACHA settings created successfully');
                
                // Reset form
                document.getElementById('createNachaSettingsForm').reset();
                
                // Refresh settings list
                fetchNachaSettings();
            } catch (error) {
                console.error('Error creating NACHA settings:', error);
                showToast('Error', error.message, true);
            } finally {
                hideLoading();
            }
        }
        
        async function handleUpdateNachaSettings() {
            try {
                const settingsId = document.getElementById('editNachaSettingsId').value;
                const settingsData = {
                    entity_id: document.getElementById('editSettingsEntityId').value || null,
                    company_name: document.getElementById('editCompanyName').value,
                    company_id: document.getElementById('editCompanyId').value,
                    originating_dfi_id: document.getElementById('editOriginatingDfiId').value,
                    company_entry_description: document.getElementById('editCompanyEntryDescription').value,
                    settlement_account_id: document.getElementById('editSettlementAccountId').value || null,
                    is_production: document.getElementById('editIsProduction').checked
                };
                
                showLoading();
                const response = await fetch(`/api/nacha-settings/${settingsId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settingsData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update NACHA settings');
                }
                
                // Close modal and show success message
                bootstrap.Modal.getInstance(document.getElementById('editNachaSettingsModal')).hide();
                showToast('Success', 'NACHA settings updated successfully');
                
                // Refresh settings list
                fetchNachaSettings();
            } catch (error) {
                console.error('Error updating NACHA settings:', error);
                showToast('Error', error.message, true);
            } finally {
                hideLoading();
            }
        }
        
        async function handleApproveBatch() {
            try {
                if (!currentBatch) return;
                
                showLoading();
                const response = await fetch(`/api/payment-batches/${currentBatch.id}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        approved_by: 'system' // In a real app, this would be the logged-in user's ID
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to approve batch');
                }
                
                showToast('Success', 'Batch approved successfully');
                
                // Refresh batch details and batches list
                fetchBatchDetails(currentBatch.id);
                fetchBatches();
            } catch (error) {
                console.error('Error approving batch:', error);
                showToast('Error', error.message, true);
            } finally {
                hideLoading();
            }
        }
        
        async function handleGenerateNachaFile() {
            try {
                if (!currentBatch) return;
                
                showLoading();
                const response = await fetch(`/api/payment-batches/${currentBatch.id}/generate-nacha`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to generate NACHA file');
                }
                
                const result = await response.json();
                
                showToast('Success', 'NACHA file generated successfully');
                
                // Refresh batch details, batches list, and NACHA files list
                fetchBatchDetails(currentBatch.id);
                fetchBatches();
                fetchNachaFiles();
                
                // Switch to NACHA files tab
                document.getElementById('files-tab').click();
            } catch (error) {
                console.error('Error generating NACHA file:', error);
                showToast('Error', error.message, true);
            } finally {
                hideLoading();
            }
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize data
            fetchEntities();
            fetchFunds();
            fetchBankAccounts();
            fetchVendors();
            fetchNachaSettings();
            fetchBatches();
            fetchNachaFiles();
            
            // Tab change handlers
            document.getElementById('vendors-tab').addEventListener('click', () => {
                fetchVendors();
            });
            
            document.getElementById('batches-tab').addEventListener('click', () => {
                fetchBatches();
            });
            
            document.getElementById('settings-tab').addEventListener('click', () => {
                fetchNachaSettings();
            });
            
            document.getElementById('files-tab').addEventListener('click', () => {
                fetchNachaFiles();
            });
            
            // Refresh buttons
            document.getElementById('refreshVendorsBtn').addEventListener('click', fetchVendors);
            document.getElementById('refreshBatchesBtn').addEventListener('click', fetchBatches);
            document.getElementById('refreshSettingsBtn').addEventListener('click', fetchNachaSettings);
            document.getElementById('refreshFilesBtn').addEventListener('click', fetchNachaFiles);
            
            // Filter handlers
            document.getElementById('batchStatusFilter').addEventListener('change', fetchBatches);
            document.getElementById('vendorStatusFilter').addEventListener('change', fetchVendors);
            
            // Search handlers
            document.getElementById('vendorSearchBtn').addEventListener('click', () => {
                // Implement vendor search
            });
            
            document.getElementById('batchSearchBtn').addEventListener('click', () => {
                // Implement batch search
            });
            
            // Close detail sections
            document.getElementById('closeVendorDetailsBtn').addEventListener('click', () => {
                document.getElementById('vendorDetailsSection').style.display = 'none';
                currentVendor = null;
            });
            
            document.getElementById('closeBatchDetailsBtn').addEventListener('click', () => {
                document.getElementById('batchDetailsSection').style.display = 'none';
                currentBatch = null;
            });
            
            // Form submit handlers
            document.getElementById('saveVendorBtn').addEventListener('click', handleCreateVendor);
            document.getElementById('updateVendorBtn').addEventListener('click', handleUpdateVendor);
            document.getElementById('saveBankAccountBtn').addEventListener('click', handleCreateBankAccount);
            document.getElementById('updateBankAccountBtn').addEventListener('click', handleUpdateBankAccount);
            document.getElementById('saveBatchBtn').addEventListener('click', handleCreateBatch);
            document.getElementById('savePaymentItemBtn').addEventListener('click', handleCreatePaymentItem);
            document.getElementById('updatePaymentItemBtn').addEventListener('click', handleUpdatePaymentItem);
            document.getElementById('saveNachaSettingsBtn').addEventListener('click', handleCreateNachaSettings);
            document.getElementById('updateNachaSettingsBtn').addEventListener('click', handleUpdateNachaSettings);
            
            // Action buttons
            document.getElementById('addBankAccountBtn').addEventListener('click', () => {
                if (currentVendor) {
                    document.getElementById('bankAccountVendorId').value = currentVendor.id;
                    const modal = new bootstrap.Modal(document.getElementById('createBankAccountModal'));
                    modal.show();
                }
            });
            
            document.getElementById('editVendorBtn').addEventListener('click', () => {
                if (currentVendor) {
                    populateEditVendorForm(currentVendor);
                    const modal = new bootstrap.Modal(document.getElementById('editVendorModal'));
                    modal.show();
                }
            });
            
            document.getElementById('addPaymentItemBtn').addEventListener('click', () => {
                if (currentBatch) {
                    document.getElementById('paymentBatchId').value = currentBatch.id;
                    const modal = new bootstrap.Modal(document.getElementById('addPaymentItemModal'));
                    modal.show();
                }
            });
            
            document.getElementById('approveBatchBtn').addEventListener('click', handleApproveBatch);
            document.getElementById('generateNachaBtn').addEventListener('click', handleGenerateNachaFile);
            
            // Vendor change handler for payment items
            document.getElementById('paymentVendorId').addEventListener('change', (e) => {
                const vendorId = e.target.value;
                if (vendorId) {
                    fetchVendorBankAccounts(vendorId, document.getElementById('vendorBankAccountId'));
                }
            });
            
            document.getElementById('editPaymentVendorId').addEventListener('change', (e) => {
                const vendorId = e.target.value;
                if (vendorId) {
                    fetchVendorBankAccounts(vendorId, document.getElementById('editVendorBankAccountId'));
                }
            });
            
            // Entity change handler for batches
            document.getElementById('batchEntityId').addEventListener('change', (e) => {
                const entityId = e.target.value;
                if (entityId) {
                    fetchFunds(entityId);
                }
            });
        });
    </script>
</body>
</html>
