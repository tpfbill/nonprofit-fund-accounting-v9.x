<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NACHA Vendor Payments - Nonprofit Fund Accounting</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .section-header {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 5px solid #0d6efd;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status-draft {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-approved {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .status-processed {
            background-color: #cfe2ff;
            color: #084298;
        }
        .status-error {
            background-color: #f8d7da;
            color: #842029;
        }
        .bank-account-card {
            border-left: 4px solid #0d6efd;
        }
        .bank-account-card.primary {
            border-left: 4px solid #198754;
        }
        .payment-item {
            transition: all 0.2s;
        }
        .payment-item:hover {
            background-color: #f8f9fa;
        }
        .badge-account {
            font-size: 0.8rem;
            font-family: monospace;
        }
        .tab-pane {
            padding: 20px 0;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        .account-number-masked {
            font-family: monospace;
        }

        /* --------------------------------------------------------------
           Consistent primary action button (imported from main app)
        -------------------------------------------------------------- */
        .action-button {
            background-color: #4caf50;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .action-button:hover {
            background-color: #43a047;
        }
        
        /* Coming soon banner */
        .coming-soon-banner {
            background-color: #e3f2fd;
            border-left: 5px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #0d47a1;
        }
    </style>
</head>
<body>
    <div class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <!-- Single centered Back button -->
        <div class="text-center mb-4">
            <button
                class="action-button"
                onclick="window.location.href='index.html'">
                <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
            </button>
        </div>
        <div class="row">
            <div class="col-12">
                <h1>NACHA Vendor Payments</h1>
                <p class="lead">Manage vendors, payment batches, and generate NACHA files for ACH transfers.</p>
            </div>
        </div>

        <ul class="nav nav-tabs" id="paymentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="batches-tab" data-bs-toggle="tab" data-bs-target="#batches" type="button" role="tab">Payment Batches</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="vendors-tab" data-bs-toggle="tab" data-bs-target="#vendors" type="button" role="tab">Vendors</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">NACHA Settings</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">NACHA Files</button>
            </li>
        </ul>

        <div class="tab-content" id="paymentTabsContent">
            <!-- PAYMENT BATCHES TAB -->
            <div class="tab-pane fade show active" id="batches" role="tabpanel">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h2>Payment Batches</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createBatchModal">
                        <i class="fas fa-plus"></i> New Batch
                    </button>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="batchSearchInput" placeholder="Search batches...">
                            <button class="btn btn-outline-secondary" type="button" id="batchSearchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end">
                            <select class="form-select me-2" id="batchStatusFilter" style="width: auto;">
                                <option value="">All Statuses</option>
                                <option value="draft">Draft</option>
                                <option value="pending_approval">Pending Approval</option>
                                <option value="approved">Approved</option>
                                <option value="processed">Processed</option>
                            </select>
                            <button class="btn btn-outline-secondary" id="refreshBatchesBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="batchesTable">
                        <thead>
                            <tr>
                                <th>Batch Number</th>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Entity</th>
                                <th>Total Amount</th>
                                <th>Items</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="batchesTableBody">
                            <!-- Batch rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Batch Details Section (hidden initially) -->
                <div id="batchDetailsSection" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 id="batchDetailsTitle">Batch Details</h3>
                            <div>
                                <button id="approveBatchBtn" class="btn btn-success me-2" style="display: none;">
                                    <i class="fas fa-check"></i> Approve Batch
                                </button>
                                <button id="generateNachaBtn" class="btn btn-primary me-2" style="display: none;">
                                    <i class="fas fa-file-export"></i> Generate NACHA File
                                </button>
                                <button id="addPaymentItemBtn" class="btn btn-outline-primary me-2" style="display: none;">
                                    <i class="fas fa-plus"></i> Add Payment
                                </button>
                                <button id="closeBatchDetailsBtn" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">Batch Number:</dt>
                                        <dd class="col-sm-8" id="detailBatchNumber"></dd>
                                        
                                        <dt class="col-sm-4">Description:</dt>
                                        <dd class="col-sm-8" id="detailDescription"></dd>
                                        
                                        <dt class="col-sm-4">Entity:</dt>
                                        <dd class="col-sm-8" id="detailEntity"></dd>
                                        
                                        <dt class="col-sm-4">Fund:</dt>
                                        <dd class="col-sm-8" id="detailFund"></dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">Batch Date:</dt>
                                        <dd class="col-sm-8" id="detailBatchDate"></dd>
                                        
                                        <dt class="col-sm-4">Effective Date:</dt>
                                        <dd class="col-sm-8" id="detailEffectiveDate"></dd>
                                        
                                        <dt class="col-sm-4">Status:</dt>
                                        <dd class="col-sm-8" id="detailStatus"></dd>
                                        
                                        <dt class="col-sm-4">NACHA Company:</dt>
                                        <dd class="col-sm-8" id="detailNachaCompany"></dd>
                                    </dl>
                                </div>
                            </div>
                            
                            <h4 class="mt-4">Payment Items</h4>
                            <div class="table-responsive">
                                <table class="table table-striped" id="paymentItemsTable">
                                    <thead>
                                        <tr>
                                            <th>Vendor</th>
                                            <th>Bank Account</th>
                                            <th>Amount</th>
                                            <th>Memo</th>
                                            <th>Invoice #</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentItemsTableBody">
                                        <!-- Payment items will be inserted here -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th colspan="2" class="text-end">Total:</th>
                                            <th id="paymentItemsTotal">$0.00</th>
                                            <th colspan="4"></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VENDORS TAB -->
            <div class="tab-pane fade" id="vendors" role="tabpanel">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h2>Vendors</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createVendorModal">
                        <i class="fas fa-plus"></i> New Vendor
                    </button>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="vendorSearchInput" placeholder="Search vendors...">
                            <button class="btn btn-outline-secondary" type="button" id="vendorSearchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end">
                            <select class="form-select me-2" id="vendorStatusFilter" style="width: auto;">
                                <option value="">All Statuses</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                            <button class="btn btn-outline-secondary" id="refreshVendorsBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="vendorsTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Bank Accounts</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vendorsTableBody">
                            <!-- Vendor rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Vendor Details Section (hidden initially) -->
                <div id="vendorDetailsSection" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 id="vendorDetailsTitle">Vendor Details</h3>
                            <div>
                                <button id="editVendorBtn" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-edit"></i> Edit Vendor
                                </button>
                                <button id="addBankAccountBtn" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-plus"></i> Add Bank Account
                                </button>
                                <button id="closeVendorDetailsBtn" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">Vendor Code:</dt>
                                        <dd class="col-sm-8" id="detailVendorCode"></dd>
                                        
                                        <dt class="col-sm-4">Name:</dt>
                                        <dd class="col-sm-8" id="detailVendorName"></dd>
                                        
                                        <dt class="col-sm-4">Tax ID:</dt>
                                        <dd class="col-sm-8" id="detailTaxId"></dd>
                                        
                                        <dt class="col-sm-4">Contact:</dt>
                                        <dd class="col-sm-8" id="detailContactName"></dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">Email:</dt>
                                        <dd class="col-sm-8" id="detailEmail"></dd>
                                        
                                        <dt class="col-sm-4">Phone:</dt>
                                        <dd class="col-sm-8" id="detailPhone"></dd>
                                        
                                        <dt class="col-sm-4">Address:</dt>
                                        <dd class="col-sm-8" id="detailAddress"></dd>
                                        
                                        <dt class="col-sm-4">Status:</dt>
                                        <dd class="col-sm-8" id="detailVendorStatus"></dd>
                                    </dl>
                                </div>
                            </div>
                            
                            <h4 class="mt-4">Bank Accounts</h4>
                            <div id="bankAccountsContainer" class="row">
                                <!-- Bank account cards will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NACHA SETTINGS TAB -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h2>NACHA Settings</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createNachaSettingsModal">
                        <i class="fas fa-plus"></i> New NACHA Configuration
                    </button>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="settingsSearchInput" placeholder="Search settings...">
                            <button class="btn btn-outline-secondary" type="button" id="settingsSearchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-outline-secondary" id="refreshSettingsBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="nachaSettingsTable">
                        <thead>
                            <tr>
                                <th>Company Name</th>
                                <th>Company ID</th>
                                <th>Originating DFI ID</th>
                                <th>Entry Description</th>
                                <th>Settlement Account</th>
                                <th>Production Mode</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="nachaSettingsTableBody">
                            <!-- NACHA settings rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- NACHA FILES TAB -->
            <div class="tab-pane fade" id="files" role="tabpanel">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h2>NACHA Files</h2>
                    <button class="btn btn-outline-secondary" id="refreshFilesBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="nachaFilesTable">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Batch Number</th>
                                <th>File Date</th>
                                <th>Total Amount</th>
                                <th>Items</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="nachaFilesTableBody">
                            <!-- NACHA files rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Create Vendor Modal -->
    <div class="modal fade" id="createVendorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Vendor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createVendorForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="vendorCode" class="form-label">Vendor Code*</label>
                                <input type="text" class="form-control" id="vendorCode" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vendorName" class="form-label">Vendor Name*</label>
                                <input type="text" class="form-control" id="vendorName" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="taxId" class="form-label">Tax ID</label>
                                <input type="text" class="form-control" id="taxId">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vendorType" class="form-label">Vendor Type</label>
                                <select class="form-select" id="vendorType">
                                    <option value="supplier">Supplier</option>
                                    <option value="contractor">Contractor</option>
                                    <option value="employee">Employee</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="contactName" class="form-label">Contact Name</label>
                                <input type="text" class="form-control" id="contactName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="phone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="entityId" class="form-label">Entity</label>
                                <select class="form-select" id="entityId">
                                    <option value="">-- Select Entity --</option>
                                    <!-- Entities will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="addressLine1" class="form-label">Address Line 1</label>
                            <input type="text" class="form-control" id="addressLine1">
                        </div>
                        
                        <div class="mb-3">
                            <label for="addressLine2" class="form-label">Address Line 2</label>
                            <input type="text" class="form-control" id="addressLine2">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="postalCode" class="form-label">Postal Code</label>
                                <input type="text" class="form-control" id="postalCode">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="country" class="form-label">Country</label>
                                <input type="text" class="form-control" id="country" value="USA">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vendorStatus" class="form-label">Status</label>
                                <select class="form-select" id="vendorStatus">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveVendorBtn">Save Vendor</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Vendor Modal -->
    <div class="modal fade" id="editVendorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Vendor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editVendorForm">
                        <input type="hidden" id="editVendorId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editVendorCode" class="form-label">Vendor Code*</label>
                                <input type="text" class="form-control" id="editVendorCode" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editVendorName" class="form-label">Vendor Name*</label>
                                <input type="text" class="form-control" id="editVendorName" required>
                            </div>
                        </div>
                        
                        <!-- Same fields as create vendor form, but with "edit" prefix -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editTaxId" class="form-label">Tax ID</label>
                                <input type="text" class="form-control" id="editTaxId">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editVendorType" class="form-label">Vendor Type</label>
                                <select class="form-select" id="editVendorType">
                                    <option value="supplier">Supplier</option>
                                    <option value="contractor">Contractor</option>
                                    <option value="employee">Employee</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editContactName" class="form-label">Contact Name</label>
                                <input type="text" class="form-control" id="editContactName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editPhone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="editPhone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editEntityId" class="form-label">Entity</label>
                                <select class="form-select" id="editEntityId">
                                    <option value="">-- Select Entity --</option>
                                    <!-- Entities will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editAddressLine1" class="form-label">Address Line 1</label>
                            <input type="text" class="form-control" id="editAddressLine1">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editAddressLine2" class="form-label">Address Line 2</label>
                            <input type="text" class="form-control" id="editAddressLine2">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="editCity" class="form-label">City</label>
                                <input type="text" class="form-control" id="editCity">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editState" class="form-label">State</label>
                                <input type="text" class="form-control" id="editState">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editPostalCode" class="form-label">Postal Code</label>
                                <input type="text" class="form-control" id="editPostalCode">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editCountry" class="form-label">Country</label>
                                <input type="text" class="form-control" id="editCountry">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editVendorStatus" class="form-label">Status</label>
                                <select class="form-select" id="editVendorStatus">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="editNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateVendorBtn">Update Vendor</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Bank Account Modal -->
    <div class="modal fade" id="createBankAccountModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Bank Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createBankAccountForm">
                        <input type="hidden" id="bankAccountVendorId">
                        
                        <div class="mb-3">
                            <label for="accountName" class="form-label">Account Name*</label>
                            <input type="text" class="form-control" id="accountName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="routingNumber" class="form-label">Routing Number*</label>
                            <input type="text" class="form-control" id="routingNumber" required maxlength="9" pattern="\d{9}">
                            <div class="form-text">9-digit ABA routing number</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="accountNumber" class="form-label">Account Number*</label>
                            <input type="text" class="form-control" id="accountNumber" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="accountType" class="form-label">Account Type*</label>
                            <select class="form-select" id="accountType" required>
                                <option value="checking">Checking</option>
                                <option value="savings">Savings</option>
                            </select>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isPrimary">
                            <label class="form-check-label" for="isPrimary">Primary Account</label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="bankAccountStatus" class="form-label">Status</label>
                            <select class="form-select" id="bankAccountStatus">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBankAccountBtn">Save Bank Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Bank Account Modal -->
    <div class="modal fade" id="editBankAccountModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Bank Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editBankAccountForm">
                        <input type="hidden" id="editBankAccountId">
                        
                        <div class="mb-3">
                            <label for="editAccountName" class="form-label">Account Name*</label>
                            <input type="text" class="form-control" id="editAccountName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editRoutingNumber" class="form-label">Routing Number*</label>
                            <input type="text" class="form-control" id="editRoutingNumber" required maxlength="9" pattern="\d{9}">
                            <div class="form-text">9-digit ABA routing number</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editAccountNumber" class="form-label">Account Number*</label>
                            <input type="text" class="form-control" id="editAccountNumber" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editAccountType" class="form-label">Account Type*</label>
                            <select class="form-select" id="editAccountType" required>
                                <option value="checking">Checking</option>
                                <option value="savings">Savings</option>
                            </select>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editIsPrimary">
                            <label class="form-check-label" for="editIsPrimary">Primary Account</label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editBankAccountStatus" class="form-label">Status</label>
                            <select class="form-select" id="editBankAccountStatus">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateBankAccountBtn">Update Bank Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Batch Modal -->
    <div class="modal fade" id="createBatchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Payment Batch</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createBatchForm">
                        <div class="mb-3">
                            <label for="batchEntityId" class="form-label">Entity*</label>
                            <select class="form-select" id="batchEntityId" required>
                                <option value="">-- Select Entity --</option>
                                <!-- Entities will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="batchFundId" class="form-label">Fund</label>
                            <select class="form-select" id="batchFundId">
                                <option value="">-- Select Fund --</option>
                                <!-- Funds will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="nachaSettingsId" class="form-label">NACHA Settings*</label>
                            <select class="form-select" id="nachaSettingsId" required>
                                <option value="">-- Select NACHA Configuration --</option>
                                <!-- NACHA settings will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="batchDate" class="form-label">Batch Date*</label>
                            <input type="date" class="form-control" id="batchDate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="effectiveDate" class="form-label">Effective Date*</label>
                            <input type="date" class="form-control" id="effectiveDate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="batchDescription" class="form-label">Description*</label>
                            <input type="text" class="form-control" id="batchDescription" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBatchBtn">Create Batch</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Payment Item Modal -->
    <div class="modal fade" id="addPaymentItemModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Payment Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPaymentItemForm">
                        <input type="hidden" id="paymentBatchId">
                        
                        <div class="mb-3">
                            <label for="paymentVendorId" class="form-label">Vendor*</label>
                            <select class="form-select" id="paymentVendorId" required>
                                <option value="">-- Select Vendor --</option>
                                <!-- Vendors will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="vendorBankAccountId" class="form-label">Bank Account*</label>
                            <select class="form-select" id="vendorBankAccountId" required>
                                <option value="">-- Select Bank Account --</option>
                                <!-- Bank accounts will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="paymentAmount" class="form-label">Amount*</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="paymentAmount" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="paymentMemo" class="form-label">Memo</label>
                            <input type="text" class="form-control" id="paymentMemo" maxlength="80">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="invoiceNumber" class="form-label">Invoice Number</label>
                                <input type="text" class="form-control" id="invoiceNumber">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="invoiceDate" class="form-label">Invoice Date</label>
                                <input type="date" class="form-control" id="invoiceDate">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dueDate" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="dueDate">
                        </div>
                        
                        <div class="mb-3">
                            <label for="addenda" class="form-label">Addenda Information</label>
                            <textarea class="form-control" id="addenda" rows="2" maxlength="80"></textarea>
                            <div class="form-text">Optional additional information to include with the payment (max 80 characters)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="savePaymentItemBtn">Add Payment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Payment Item Modal -->
    <div class="modal fade" id="editPaymentItemModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Payment Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editPaymentItemForm">
                        <input type="hidden" id="editPaymentItemId">
                        
                        <div class="mb-3">
                            <label for="editPaymentVendorId" class="form-label">Vendor*</label>
                            <select class="form-select" id="editPaymentVendorId" required>
                                <option value="">-- Select Vendor --</option>
                                <!-- Vendors will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editVendorBankAccountId" class="form-label">Bank Account*</label>
                            <select class="form-select" id="editVendorBankAccountId" required>
                                <option value="">-- Select Bank Account --</option>
                                <!-- Bank accounts will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editPaymentAmount" class="form-label">Amount*</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="editPaymentAmount" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editPaymentMemo" class="form-label">Memo</label>
                            <input type="text" class="form-control" id="editPaymentMemo" maxlength="80">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editInvoiceNumber" class="form-label">Invoice Number</label>
                                <input type="text" class="form-control" id="editInvoiceNumber">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editInvoiceDate" class="form-label">Invoice Date</label>
                                <input type="date" class="form-control" id="editInvoiceDate">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editDueDate" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="editDueDate">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editAddenda" class="form-label">Addenda Information</label>
                            <textarea class="form-control" id="editAddenda" rows="2" maxlength="80"></textarea>
                            <div class="form-text">Optional additional information to include with the payment (max 80 characters)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updatePaymentItemBtn">Update Payment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create NACHA Settings Modal -->
    <div class="modal fade" id="createNachaSettingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create NACHA Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createNachaSettingsForm">
                        <div class="mb-3">
                            <label for="settingsEntityId" class="form-label">Entity</label>
                            <select class="form-select" id="settingsEntityId">
                                <option value="">-- Select Entity --</option>
                                <!-- Entities will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="companyName" class="form-label">Company Name*</label>
                            <input type="text" class="form-control" id="companyName" required maxlength="16">
                            <div class="form-text">Max 16 characters (NACHA requirement)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="companyId" class="form-label">Company ID*</label>
                            <input type="text" class="form-control" id="companyId" required maxlength="10">
                            <div class="form-text">Tax ID or NACHA assigned ID (max 10 digits)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="originatingDfiId" class="form-label">Originating DFI ID*</label>
                            <input type="text" class="form-control" id="originatingDfiId" required maxlength="8" pattern="\d{8}">
                            <div class="form-text">First 8 digits of your bank's routing number</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="companyEntryDescription" class="form-label">Company Entry Description*</label>
                            <input type="text" class="form-control" id="companyEntryDescription" required maxlength="10">
                            <div class="form-text">Description that appears on receiver's bank statement (e.g., PAYROLL, VENDOR)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="settlementAccountId" class="form-label">Settlement Account</label>
                            <select class="form-select" id="settlementAccountId">
                                <option value="">-- Select Bank Account --</option>
                                <!-- Bank accounts will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isProduction">
                            <label class="form-check-label" for="isProduction">Production Mode</label>
                            <div class="form-text">Check for production files, uncheck for test files</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNachaSettingsBtn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit NACHA Settings Modal -->
    <div class="modal fade" id="editNachaSettingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit NACHA Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editNachaSettingsForm">
                        <input type="hidden" id="editNachaSettingsId">
                        
                        <div class="mb-3">
                            <label for="editSettingsEntityId" class="form-label">Entity</label>
                            <select class="form-select" id="editSettingsEntityId">
                                <option value="">-- Select Entity --</option>
                                <!-- Entities will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editCompanyName" class="form-label">Company Name*</label>
                            <input type="text" class="form-control" id="editCompanyName" required maxlength="16">
                            <div class="form-text">Max 16 characters (NACHA requirement)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editCompanyId" class="form-label">Company ID*</label>
                            <input type="text" class="form-control" id="editCompanyId" required maxlength="10">
                            <div class="form-text">Tax ID or NACHA assigned ID (max 10 digits)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editOriginatingDfiId" class="form-label">Originating DFI ID*</label>
                            <input type="text" class="form-control" id="editOriginatingDfiId" required maxlength="8" pattern="\d{8}">
                            <div class="form-text">First 8 digits of your bank's routing number</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editCompanyEntryDescription" class="form-label">Company Entry Description*</label>
                            <input type="text" class="form-control" id="editCompanyEntryDescription" required maxlength="10">
                            <div class="form-text">Description that appears on receiver's bank statement (e.g., PAYROLL, VENDOR)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editSettlementAccountId" class="form-label">Settlement Account</label>
                            <select class="form-select" id="editSettlementAccountId">
                                <option value="">-- Select Bank Account --</option>
                                <!-- Bank accounts will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editIsProduction">
                            <label class="form-check-label" for="editIsProduction">Production Mode</label>
                            <div class="form-text">Check for production files, uncheck for test files</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateNachaSettingsBtn">Update Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationTitle">Confirmation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmationMessage">Are you sure you want to proceed?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Operation completed successfully.
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        /********************************************************************
         * NACHA Vendor Payments  client-side fallback for missing endpoints
         * ------------------------------------------------------------------
         * 1. Intercepts fetch calls to specific NACHA endpoints that don't exist
         *    and returns empty arrays instead of 404 errors.
         * 2. Suppresses error toasts for those endpoints.
         * 3. Uses precise path matching to avoid interfering with legitimate
         *    API calls like /api/entities and /api/funds.
         ********************************************************************/
        (() => {
            // Specific NACHA endpoints that don't exist yet
            const missingEndpoints = [
                '/api/payment-batches',
                '/api/vendors',
                '/api/nacha-settings',
                '/api/nacha-files'
            ];

            // Helper to extract path from URL for precise matching
            function getPathFromUrl(url) {
                try {
                    // Handle both URL objects and strings
                    const urlObj = typeof url === 'string' ? new URL(url, window.location.origin) : url;
                    // Get pathname and remove trailing slash if present
                    let path = urlObj.pathname;
                    if (path.endsWith('/')) path = path.slice(0, -1);
                    return path;
                } catch (e) {
                    // If URL parsing fails, return the original string
                    console.debug('[URL Parse] Failed to parse URL:', url);
                    return typeof url === 'string' ? url : String(url);
                }
            }

            // Is this a missing NACHA endpoint or a child of one?
            function isMissingNachaEndpoint(url) {
                if (!url) return false;
                
                const path = getPathFromUrl(url);
                console.debug('[Endpoint Check] Checking path:', path);
                
                // Check if this is a missing endpoint or a child of one
                return missingEndpoints.some(endpoint => {
                    // Exact match
                    if (path === endpoint) return true;
                    
                    // Child path (e.g., /api/vendors/123)
                    if (path.startsWith(endpoint + '/')) return true;
                    
                    // Query parameters (e.g., /api/payment-batches?status=draft)
                    if (path === endpoint.split('?')[0]) return true;
                    
                    return false;
                });
            }

            // Store the original fetch function
            const originalFetch = window.fetch;
            
            // Override fetch to intercept missing NACHA endpoints
            window.fetch = function(url, options) {
                // Check if this URL is a missing NACHA endpoint
                if (url && isMissingNachaEndpoint(url)) {
                    console.info('[API Intercept] Handling missing NACHA endpoint:', url);
                    
                    // First try the original fetch to see if it's a 404
                    return originalFetch(url, options)
                        .then(response => {
                            if (response.status === 404) {
                                console.info('[API Intercept] Returning mock data for missing endpoint:', url);
                                return Promise.resolve(new Response('[]', { 
                                    status: 200,
                                    headers: { 'Content-Type': 'application/json' }
                                }));
                            }
                            return response;
                        })
                        .catch(err => {
                            console.warn('[API Intercept] Error fetching:', err);
                            // Return empty array for network errors too
                            return Promise.resolve(new Response('[]', { 
                                status: 200,
                                headers: { 'Content-Type': 'application/json' }
                            }));
                        });
                }
                
                // For all other URLs, use the original fetch
                return originalFetch(url, options);
            };

            // Override showToast to suppress errors for missing endpoints
            const originalToast = window.showToast ?? (() => {});
            window.showToast = (title, msg, isErr) => {
                // Suppress specific error messages for missing NACHA endpoints
                if (
                    isErr &&
                    msg.match(/Failed to load (payment batches|vendors|NACHA settings|vendor bank accounts|NACHA files)/i)
                ) {
                    console.info('[Toast Suppress] Suppressed error toast:', msg);
                    return;
                }
                originalToast(title, msg, isErr);
            };
            
            console.info('[API Intercept] Initialized - Missing NACHA endpoints will return empty arrays');
        })();

        // API Configuration
        const API_BASE_URL = 'http://localhost:3000';
        
        // Global variables
        let currentVendor = null;
        let currentBatch = null;
        let entities = [];
        let funds = [];
        let bankAccounts = [];
        let vendors = [];
        let nachaSettings = [];
        
        // Utility functions
        function showLoading() {
            document.querySelector('.loading-overlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.querySelector('.loading-overlay').style.display = 'none';
        }
        
        function showToast(title, message, isError = false) {
            const toast = document.getElementById('toastNotification');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            if (isError) {
                toast.classList.add('bg-danger', 'text-white');
            } else {
                toast.classList.remove('bg-danger', 'text-white');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US');
        }
        
        function maskAccountNumber(accountNumber) {
            if (!accountNumber) return '';
            const visible = accountNumber.slice(-4);
            const masked = 'X'.repeat(accountNumber.length - 4);
            return masked + visible;
        }
        
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'draft': return 'bg-secondary';
                case 'pending_approval': return 'bg-warning';
                case 'approved': return 'bg-success';
                case 'processed': return 'bg-primary';
                case 'transmitted': return 'bg-info';
                case 'confirmed': return 'bg-success';
                case 'rejected': return 'bg-danger';
                case 'error': return 'bg-danger';
                case 'active': return 'bg-success';
                case 'inactive': return 'bg-secondary';
                case 'suspended': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        /**
         * Helper function to handle API responses with proper error handling
         * @param {Response} response - The fetch response object
         * @param {string} endpoint - The API endpoint for logging
         * @returns {Promise<any>} - Resolves to the JSON data or empty array for 404s
         * @throws {Error} - For non-404 errors
         */
        async function handleApiResponse(response, endpoint) {
            if (!response.ok) {
                if (response.status === 404) {
                    console.info(`[API] ${endpoint} not available (404) - feature not implemented yet`);
                    return []; // Return empty array for 404 errors
                }
                // For other errors, throw to be caught by the calling function
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }
            return await response.json();
        }

        /**
         * Shows a "Coming Soon" message in the specified table body
         * @param {string} tableBodyId - The ID of the table body element
         * @param {number} colSpan - The number of columns to span
         * @param {string} message - The message to display
         */
        function showComingSoonMessage(tableBodyId, colSpan, message = "This feature is coming soon") {
            const tableBody = document.getElementById(tableBodyId);
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = colSpan;
            cell.className = 'text-center p-4';
            
            const alert = document.createElement('div');
            alert.className = 'coming-soon-banner';
            alert.innerHTML = `
                <h5 class="mb-2"><i class="fas fa-tools me-2"></i> ${message}</h5>
                <p class="mb-0">The backend API for this feature is not yet implemented.</p>
            `;
            
            cell.appendChild(alert);
            row.appendChild(cell);
            tableBody.appendChild(row);
        }
        
        // API Calls
        async function fetchEntities() {
            try {
                console.debug('[API Call] Fetching entities from /api/entities');
                const response = await fetch(`${API_BASE_URL}/api/entities`);
                entities = await handleApiResponse(response, 'entities');
                console.debug('[API Result] Entities loaded:', entities.length);
                
                // Populate entity dropdowns
                const entitySelects = [
                    document.getElementById('entityId'),
                    document.getElementById('editEntityId'),
                    document.getElementById('batchEntityId'),
                    document.getElementById('settingsEntityId'),
                    document.getElementById('editSettingsEntityId')
                ];
                
                // DEBUG: log which selects are detected (helps confirm presence when modal is open/closed)
                console.debug(
                    '[fetchEntities] selects found:',
                    entitySelects.map(s => (s ? `${s.id} ` : 'null '))
                );

                entitySelects.forEach(select => {
                    if (!select) return;
                    
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add entity options
                    entities.forEach(entity => {
                        const option = document.createElement('option');
                        option.value = entity.id;
                        option.textContent = entity.name;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error fetching entities:', error);
                // Only show toast for non-404 errors
                if (!error.message.includes('404')) {
                    showToast('Error', 'Failed to load entities', true);
                }
            }
        }
        
        async function fetchFunds(entityId = null) {
            try {
                const url = entityId ? `${API_BASE_URL}/api/funds?entityId=${entityId}` : `${API_BASE_URL}/api/funds`;
                console.debug('[API Call] Fetching funds from', url);
                const response = await fetch(url);
                funds = await handleApiResponse(response, 'funds');
                console.debug('[API Result] Funds loaded:', funds.length);
                
                // Populate fund dropdowns
                const fundSelects = [
                    document.getElementById('batchFundId')
                ];
                
                fundSelects.forEach(select => {
                    if (!select) return;
                    
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add fund options
                    funds.forEach(fund => {
                        const option = document.createElement('option');
                        option.value = fund.id;
                        option.textContent = fund.name;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error fetching funds:', error);
                // Only show toast for non-404 errors
                if (!error.message.includes('404')) {
                    showToast('Error', 'Failed to load funds', true);
                }
            }
        }
        
        async function fetchBankAccounts() {
            try {
                console.debug('[API Call] Fetching bank accounts from /api/bank-accounts');
                const response = await fetch(`${API_BASE_URL}/api/bank-accounts`);

                /* ----------------------------------------------------------
                   Gracefully handle missing endpoint
                   ----------------------------------------------------------
                   Some installations may not yet expose /api/bank-accounts.
                   If the endpoint returns 404 we treat it as "feature not
                   implemented"  log and exit without bothering the user.
                ---------------------------------------------------------- */
                if (!response.ok) {
                    if (response.status === 404) {
                        console.info(
                            '[fetchBankAccounts] /api/bank-accounts not available (404)  skipping'
                        );
                        return; // silently ignore
                    }
                    // For other HTTP errors, escalate to catch block
                    throw new Error(`HTTP ${response.status}`);
                }

                bankAccounts = await response.json();
                console.debug('[API Result] Bank accounts loaded:', bankAccounts.length);
                
                // Populate bank account dropdowns
                const bankAccountSelects = [
                    document.getElementById('settlementAccountId'),
                    document.getElementById('editSettlementAccountId')
                ];
                
                bankAccountSelects.forEach(select => {
                    if (!select) return;
                    
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add bank account options
                    bankAccounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.textContent = `${account.account_name} (${account.bank_name})`;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error fetching bank accounts:', error);
                // Only show toast for non-404 errors
                if (!error.message.includes('404')) {
                    showToast('Error', 'Failed to load bank accounts', true);
                }
            }
        }
        
        async function fetchVendors() {
            try {
                showLoading();
                console.debug('[API Call] Fetching vendors from /api/vendors');
                const response = await fetch(`${API_BASE_URL}/api/vendors`);
                
                // Handle 404 (endpoint not implemented) gracefully
                if (!response.ok) {
                    if (response.status === 404) {
                        console.info('[fetchVendors] /api/vendors not available (404) - feature not implemented yet');
                        vendors = [];
                        showComingSoonMessage('vendorsTableBody', 8, 'Vendor Management Coming Soon');
                        hideLoading();
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                vendors = await response.json();
                console.debug('[API Result] Vendors loaded:', vendors.length);
                renderVendorsTable();
                
                // Populate vendor dropdowns
                const vendorSelects = [
                    document.getElementById('paymentVendorId'),
                    document.getElementById('editPaymentVendorId')
                ];
                
                vendorSelects.forEach(select => {
                    if (!select) return;
                    
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add vendor options
                    vendors.forEach(vendor => {
                        const option = document.createElement('option');
                        option.value = vendor.id;
                        option.textContent = `${vendor.name} (${vendor.vendor_code})`;
                        select.appendChild(option);
                    });
                });
                
                hideLoading